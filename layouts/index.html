<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCP Maintenance Window Visualizer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #calendar {
            max-width: 900px;
            margin: 40px auto;
            border: 1px solid #ccc;
            padding: 10px;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input, select {
            width: 300px;
            padding: 5px;
        }
        button {
            margin-top: 15px;
            padding: 10px 20px;
        }
        .event {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8d7da;
            border-left: 5px solid #f5c6cb;
        }
        .error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<h1>GCP Maintenance Window Visualizer</h1>

<form id="maintenance-form">
    <label>
        Maintenance Start (YYYY-MM-DDTHH:MM:SSZ):
        <input type="text" id="maintenance-start" value="2024-10-01T00:00:00Z">
    </label>
    <label>
        Maintenance End (YYYY-MM-DDTHH:MM:SSZ):
        <input type="text" id="maintenance-end" value="2024-10-01T01:00:00Z">
    </label>
    <label>
        Maintenance Frequency (e.g., 'FREQ=WEEKLY;BYDAY=MO,WE,FR'):
        <input type="text" id="maintenance-frequency" value="FREQ=WEEKLY;BYDAY=MO,WE,FR">
    </label>
    <label>
        Time Zone:
        <select id="timezone">
            <option value="UTC">UTC</option>
            <option value="America/Chicago">CDT (America/Chicago)</option>
            <option value="America/New_York">EDT (America/New_York)</option>
            <option value="America/Los_Angeles">PDT (America/Los_Angeles)</option>
            <option value="Europe/London">BST (Europe/London)</option>
        </select>
    </label>
    <button type="button" id="update-button">Update Calendar</button>
</form>

<div id='calendar'></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('update-button').addEventListener('click', function () {
            updateCalendar();
        });

        function parseMaintenanceFrequency(frequencyString) {
            try {
                const params = {};
                frequencyString.split(';').forEach(param => {
                    const [key, value] = param.split('=');
                    params[key] = value;
                });

                if (!params.FREQ || !['WEEKLY', 'DAILY'].includes(params.FREQ)) {
                    throw new Error('FREQ must be either WEEKLY or DAILY');
                }

                if (params.FREQ === 'WEEKLY' && params.BYDAY) {
                    const days = params.BYDAY.split(',');
                    const validDays = ['MO', 'TU', 'WE', 'TH', 'FR', 'SA', 'SU'];
                    const invalidDays = days.filter(day => !validDays.includes(day));
                    if (invalidDays.length > 0) {
                        throw new Error(`Invalid days: ${invalidDays.join(', ')}`);
                    }
                }

                return {
                    frequency: params.FREQ,
                    days: params.BYDAY ? params.BYDAY.split(',') : null
                };
            } catch (error) {
                throw new Error(`Invalid frequency format: ${error.message}`);
            }
        }

        function updateCalendar() {
            try {
                var startInput = document.getElementById('maintenance-start').value.trim();
                var endInput = document.getElementById('maintenance-end').value.trim();
                var freqInput = document.getElementById('maintenance-frequency').value.trim();
                var timezone = document.getElementById('timezone').value;

                // Parse start and end times
                var dtstart = new Date(startInput);
                var dtend = new Date(endInput);

                if (isNaN(dtstart) || isNaN(dtend)) {
                    throw new Error('Invalid start or end date');
                }

                // Compute duration in milliseconds
                var durationMs = dtend - dtstart;

                // Parse frequency using the new format
                const { frequency, days } = parseMaintenanceFrequency(freqInput);

                // Generate occurrences (next 3 months)
                var now = new Date();
                var afterThreeMonths = new Date();
                afterThreeMonths.setMonth(afterThreeMonths.getMonth() + 3);

                var currentDate = new Date(dtstart);
                var events = [];

                const dayMap = {
                    'MO': 1, 'TU': 2, 'WE': 3, 'TH': 4, 'FR': 5, 'SA': 6, 'SU': 0
                };

                while (currentDate <= afterThreeMonths) {
                    const dayOfWeek = currentDate.getUTCDay();
                    const shouldInclude = frequency === 'DAILY' || 
                        (frequency === 'WEEKLY' && (!days || days.some(day => dayMap[day] === dayOfWeek)));

                    if (shouldInclude) {
                        var eventStart = new Date(currentDate);
                        var eventEnd = new Date(currentDate.getTime() + durationMs);

                        // Convert to selected timezone
                        var eventStartStr = eventStart.toLocaleString('en-US', { timeZone: timezone });
                        var eventEndStr = eventEnd.toLocaleString('en-US', { timeZone: timezone });

                        events.push({
                            start: eventStartStr,
                            end: eventEndStr
                        });
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                // Display events
                var calendarDiv = document.getElementById('calendar');
                calendarDiv.innerHTML = '';

                if (events.length === 0) {
                    calendarDiv.innerHTML = '<p>No occurrences found in the next three months.</p>';
                    return;
                }

                events.forEach(function (event) {
                    var eventDiv = document.createElement('div');
                    eventDiv.className = 'event';
                    eventDiv.innerHTML = '<strong>Maintenance Window:</strong><br>' +
                        'Start: ' + event.start + '<br>' +
                        'End: ' + event.end;
                    calendarDiv.appendChild(eventDiv);
                });
            } catch (error) {
                var calendarDiv = document.getElementById('calendar');
                calendarDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }
    });
</script>

</body>
</html>